#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")/.."

# ensure bun/cargo are in PATH
[[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"
export PATH="${HOME}/.bun/bin:$PATH"

usage() {
  cat <<EOF
usage: ./bin/dev [--browser | --desktop]

  --browser   vite dev server + gatekeeper (default)
  --desktop   cargo tauri dev (spawns gatekeeper from rust)
EOF
  exit 1
}

mode="browser"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --browser)  mode="browser"; shift ;;
    --desktop)  mode="desktop"; shift ;;
    -h|--help)  usage ;;
    *)          echo "unknown flag: $1" >&2; usage ;;
  esac
done

cleanup() {
  echo ""
  echo "shutting down..."
  kill "$gk_pid" 2>/dev/null || true
  kill "$vite_pid" 2>/dev/null || true
  wait 2>/dev/null || true
}

if [[ "$mode" == "browser" ]]; then
  echo "==> starting gatekeeper on :3001"
  bun run gatekeeper/src/index.ts &
  gk_pid=$!

  # wait for gatekeeper to be ready (up to 5 seconds)
  for i in $(seq 1 20); do
    curl -sf http://localhost:3001/health >/dev/null 2>&1 && break
    sleep 0.25
  done

  if curl -sf http://localhost:3001/health >/dev/null 2>&1; then
    echo "  gatekeeper ready"
  else
    echo "  WARNING: gatekeeper not responding on :3001"
  fi

  echo "==> starting vite on :1420"
  bun run dev &
  vite_pid=$!

  trap cleanup EXIT INT TERM

  echo ""
  echo "  browser: http://localhost:1420"
  echo "  gatekeeper: http://localhost:3001"
  echo ""

  wait
else
  echo "==> cargo tauri dev"
  echo "  (gatekeeper is spawned by the rust backend)"
  echo ""
  cargo tauri dev
fi
