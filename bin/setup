#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")/.."

echo "==> checking prerequisites"

ensure_bun() {
  if command -v bun &>/dev/null; then
    printf "  %-12s %s\n" "bun" "$(command -v bun)"
    return
  fi
  echo "  bun not found — installing..."
  curl -fsSL https://bun.sh/install | bash
  # source the env so bun is available in this session
  export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
  export PATH="$BUN_INSTALL/bin:$PATH"
  printf "  %-12s %s\n" "bun" "$(command -v bun)"
}

ensure_rust() {
  if command -v rustc &>/dev/null && command -v cargo &>/dev/null; then
    printf "  %-12s %s\n" "rustc" "$(command -v rustc)"
    printf "  %-12s %s\n" "cargo" "$(command -v cargo)"
    return
  fi
  echo "  rust not found — installing via rustup..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --quiet
  source "$HOME/.cargo/env"
  printf "  %-12s %s\n" "rustc" "$(command -v rustc)"
  printf "  %-12s %s\n" "cargo" "$(command -v cargo)"
}

ensure_bun
ensure_rust

echo ""
echo "==> bun install"
bun install

echo ""
echo "==> cargo fetch (tauri dependencies)"
cargo fetch --manifest-path src-tauri/Cargo.toml

# linux: verify system libs tauri needs
if [[ "$(uname)" == "Linux" ]]; then
  echo ""
  echo "==> checking linux system libraries"
  missing=()
  for pkg in libwebkit2gtk-4.1-dev libgtk-3-dev libappindicator3-dev librsvg2-dev; do
    if ! dpkg -s "$pkg" &>/dev/null; then
      missing+=("$pkg")
    fi
  done
  if [[ ${#missing[@]} -gt 0 ]]; then
    echo "  missing: ${missing[*]}"
    echo "  install with: sudo apt-get install -y ${missing[*]}"
  else
    echo "  all present"
  fi

  # fix ghostscript-as-cc if needed
  if cc --version 2>&1 | grep -qi ghostscript; then
    echo ""
    echo "==> fixing linker (cc points to ghostscript)"
    mkdir -p .cargo
    cat > .cargo/config.toml <<'TOML'
[target.x86_64-unknown-linux-gnu]
linker = "/usr/bin/gcc"
TOML
    echo "  wrote .cargo/config.toml"
  fi
fi

echo ""
echo "==> verifying rust build"
cargo check --manifest-path src-tauri/Cargo.toml 2>&1 | tail -1

echo ""
echo "==> verifying gatekeeper"
timeout 3 bun run gatekeeper/src/index.ts &
gk_pid=$!
sleep 1
if curl -sf http://localhost:3001/health >/dev/null 2>&1; then
  echo "  gatekeeper ok"
else
  echo "  gatekeeper failed to start"
fi
kill "$gk_pid" 2>/dev/null || true
wait "$gk_pid" 2>/dev/null || true

echo ""
echo "done. run ./bin/dev to start developing."
