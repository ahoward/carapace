#!/usr/bin/env bash
set -euo pipefail

cd "$(dirname "$0")/.."

# always source these if they exist — tools may have been installed
# by a previous run but aren't in the user's shell profile yet
[[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"
export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
export PATH="$BUN_INSTALL/bin:$PATH"

echo "==> checking prerequisites"

# macOS: ensure xcode command line tools
if [[ "$(uname)" == "Darwin" ]]; then
  if ! xcode-select -p &>/dev/null; then
    echo "  xcode cli tools not found — installing (this may take a while)..."
    xcode-select --install 2>/dev/null || true
    echo "  waiting for xcode cli tools install to finish..."
    until xcode-select -p &>/dev/null; do sleep 5; done
  fi
  printf "  %-12s %s\n" "xcode-cli" "$(xcode-select -p)"
fi

ensure_bun() {
  if command -v bun &>/dev/null; then
    printf "  %-12s %s\n" "bun" "$(command -v bun)"
    return
  fi
  echo "  bun not found — installing..."
  curl -fsSL https://bun.sh/install | bash
  export BUN_INSTALL="${BUN_INSTALL:-$HOME/.bun}"
  export PATH="$BUN_INSTALL/bin:$PATH"
  printf "  %-12s %s\n" "bun" "$(command -v bun)"
}

ensure_rust() {
  if command -v rustc &>/dev/null && command -v cargo &>/dev/null; then
    printf "  %-12s %s\n" "rustc" "$(command -v rustc)"
    printf "  %-12s %s\n" "cargo" "$(command -v cargo)"
    return
  fi
  echo "  rust not found — installing via rustup..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --quiet
  source "$HOME/.cargo/env"
  printf "  %-12s %s\n" "rustc" "$(command -v rustc)"
  printf "  %-12s %s\n" "cargo" "$(command -v cargo)"
}

ensure_shell_profile() {
  # figure out which profile file to use
  local profile=""
  if [[ -n "${ZSH_VERSION:-}" ]] || [[ "$SHELL" == */zsh ]]; then
    profile="$HOME/.zshrc"
  elif [[ -f "$HOME/.bash_profile" ]]; then
    profile="$HOME/.bash_profile"
  else
    profile="$HOME/.bashrc"
  fi

  local changed=false

  if ! grep -q '\.cargo/env' "$profile" 2>/dev/null; then
    echo '' >> "$profile"
    echo '# rust (added by carapace script/setup)' >> "$profile"
    echo '[[ -f "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"' >> "$profile"
    changed=true
  fi

  if ! grep -q '\.bun/bin' "$profile" 2>/dev/null; then
    echo '' >> "$profile"
    echo '# bun (added by carapace script/setup)' >> "$profile"
    echo 'export PATH="$HOME/.bun/bin:$PATH"' >> "$profile"
    changed=true
  fi

  if ! grep -q '\.carapace/tools/bin' "$profile" 2>/dev/null; then
    echo '' >> "$profile"
    echo '# carapace cloud tools (added by carapace script/setup)' >> "$profile"
    echo 'export PATH="$HOME/.carapace/tools/bin:$PATH"' >> "$profile"
    changed=true
  fi

  if [[ "$changed" == "true" ]]; then
    echo "  updated $profile with bun/cargo/carapace PATH entries"
  fi
}

ensure_uv() {
  local uv_bin="$HOME/.carapace/uv/bin/uv"
  if [[ -x "$uv_bin" ]]; then
    printf "  %-12s %s\n" "uv" "$uv_bin"
    return
  fi
  echo "  uv not found — installing..."
  local arch os_name target
  arch="$(uname -m)"
  case "$arch" in
    arm64|aarch64) arch="aarch64" ;;
    *) arch="x86_64" ;;
  esac
  case "$(uname)" in
    Darwin) os_name="apple-darwin" ;;
    *) os_name="unknown-linux-gnu" ;;
  esac
  target="uv-${arch}-${os_name}"
  local url="https://github.com/astral-sh/uv/releases/latest/download/${target}.tar.gz"
  mkdir -p "$HOME/.carapace/uv/bin"
  curl -fsSL "$url" | tar xzf - --strip-components=1 -C "$HOME/.carapace/uv/bin"
  chmod +x "$uv_bin"
  printf "  %-12s %s\n" "uv" "$uv_bin"
}

ensure_skypilot() {
  local sky_bin="$HOME/.carapace/tools/bin/sky"
  if [[ -x "$sky_bin" ]]; then
    printf "  %-12s %s\n" "sky" "$sky_bin"
    return
  fi
  echo "  sky not found — installing via uv..."
  local uv_bin="$HOME/.carapace/uv/bin/uv"
  export UV_TOOL_BIN_DIR="$HOME/.carapace/tools/bin"
  export UV_TOOL_DIR="$HOME/.carapace/tools/environments"
  export UV_PYTHON_INSTALL_DIR="$HOME/.carapace/python"
  mkdir -p "$UV_TOOL_BIN_DIR" "$UV_TOOL_DIR" "$UV_PYTHON_INSTALL_DIR"
  "$uv_bin" tool install --with pip "skypilot-nightly[aws]"
  echo "  installing AWS CLI..."
  "$uv_bin" tool install --with pip awscli || true
  printf "  %-12s %s\n" "sky" "$sky_bin"
}

ensure_bun
ensure_rust
ensure_uv
ensure_skypilot
ensure_shell_profile

echo ""
echo "==> bun install"
bun install

echo ""
echo "==> cargo fetch (tauri dependencies)"
cargo fetch --manifest-path src-tauri/Cargo.toml

# fix cc pointing to ghostscript (both machines have ~/bin/cc = gs)
if cc --version 2>&1 | grep -qi ghostscript; then
  echo ""
  echo "==> fixing cc (cc points to ghostscript, not a C compiler)"
  mkdir -p .cargo
  if [[ "$(uname)" == "Darwin" ]]; then
    cat > .cargo/config.toml <<'TOML'
[target.aarch64-apple-darwin]
linker = "/usr/bin/cc"

[target.x86_64-apple-darwin]
linker = "/usr/bin/cc"
TOML
  else
    cat > .cargo/config.toml <<'TOML'
[target.x86_64-unknown-linux-gnu]
linker = "/usr/bin/gcc"
TOML
  fi
  echo "  wrote .cargo/config.toml (points cargo at the real compiler)"
  echo "  cleaning cargo cache to pick up new linker config..."
  cargo clean --manifest-path src-tauri/Cargo.toml 2>/dev/null || true
fi

# linux: verify system libs tauri needs
if [[ "$(uname)" == "Linux" ]]; then
  echo ""
  echo "==> checking linux system libraries"
  missing=()
  for pkg in libwebkit2gtk-4.1-dev libgtk-3-dev libappindicator3-dev librsvg2-dev; do
    if ! dpkg -s "$pkg" &>/dev/null; then
      missing+=("$pkg")
    fi
  done
  if [[ ${#missing[@]} -gt 0 ]]; then
    echo "  missing: ${missing[*]}"
    echo "  install with: sudo apt-get install -y ${missing[*]}"
  else
    echo "  all present"
  fi
fi

echo ""
echo "==> verifying rust build"
cargo_output=$(cargo check --manifest-path src-tauri/Cargo.toml 2>&1) && cargo_ok=true || cargo_ok=false
echo "$cargo_output" | tail -5
if [[ "$cargo_ok" != "true" ]]; then
  echo ""
  echo "  cargo check failed. common fixes:"
  if [[ "$(uname)" == "Darwin" ]]; then
    echo "    xcode-select --install"
    echo "    sudo xcode-select --reset"
  else
    echo "    sudo apt-get install -y build-essential"
  fi
  echo "  then re-run: ./script/setup"
fi

echo ""
echo "==> verifying gatekeeper"
bun run gatekeeper/src/index.ts &
gk_pid=$!
sleep 1
if curl -sf http://localhost:3001/health >/dev/null 2>&1; then
  echo "  gatekeeper ok"
else
  echo "  gatekeeper failed to start"
fi
kill "$gk_pid" 2>/dev/null || true
wait "$gk_pid" 2>/dev/null || true

echo ""
echo "done. run ./script/dev to start developing."
