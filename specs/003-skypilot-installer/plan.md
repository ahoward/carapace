# Implementation Plan: SkyPilot Automatic Installer

**Branch**: `003-skypilot-installer` | **Date**: 2026-02-14 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/003-skypilot-installer/spec.md`

## Summary

Bundle SkyPilot CLI into Carapace via the uv package manager. One install code path (steel thread) for runtime auto-install, developer setup (`bin/setup`), and container builds (Dockerfile). uv is downloaded to `~/.carapace/uv/bin/uv`, then `uv tool install skypilot-nightly[aws]` creates an isolated environment with its own Python runtime at `~/.carapace/tools/`. Lazy install on first cloud action, with progress streamed via existing SSE event bus.

## Technical Context

**Language/Version**: TypeScript (Bun runtime) + Bash (bin/setup)
**Primary Dependencies**: uv (astral-sh/uv v0.10.2), skypilot-nightly[aws]
**Storage**: Filesystem only — `~/.carapace/` directory tree, no database
**Testing**: `bun:test` (Bun's built-in test runner)
**Target Platform**: macOS (arm64, x86_64), Linux (x86_64)
**Project Type**: Existing Tauri + React + Bun/TS gatekeeper
**Performance Goals**: Install detection <2s, full install <3 min on 25 Mbps
**Constraints**: No system Python required, idempotent, cross-platform, single code path
**Scale/Scope**: Single-user desktop app

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-checked after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Privacy by Default | PASS | Installer downloads from public GitHub/PyPI — no user data transmitted |
| II. Data Sovereignty | PASS | Tools installed locally to `~/.carapace/`, user controls all files |
| III. Zero Configuration | PASS | Core goal: auto-install on first use, no terminal commands needed |
| IV. Thin Desktop Shell | PASS | Installer lives in Gatekeeper (Bun/TS), not in Tauri/Rust layer |
| V. Vertical Slice | PASS | Thin end-to-end: installer → handler auto-install → SSE progress → UI |
| VI. Upstream Integrity | PASS | SkyPilot consumed as published PyPI package via uv, not forked |
| VII. Fail Secure | PASS | Install failure → error state, cloud ops blocked until resolved |
| `.envrc` protection | PASS | Feature does not touch `.envrc` |
| Spec-driven workflow | PASS | Full spec-kit cycle: specify → plan → tasks → implement |
| Step-by-step delivery | PASS | 8 incremental steps, each pushable and testable |

**Post-design re-check**: All gates still pass. No constitution violations.

## Project Structure

### Documentation (this feature)

```text
specs/003-skypilot-installer/
├── spec.md
├── plan.md              # This file
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── installer-api.md
├── checklists/
│   └── requirements.md
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (modified/new files)

```text
gatekeeper/
├── src/
│   ├── services/
│   │   ├── uv_installer.ts      # NEW — THE steel thread installer
│   │   └── sky_runner.ts         # MODIFIED — sky_binary() checks managed path
│   ├── handlers/
│   │   └── cluster.ts            # MODIFIED — auto-install flow, new endpoints
│   ├── types.ts                  # MODIFIED — InstallPhase, InstallProgress, InstallStatus
│   ├── index.ts                  # MODIFIED — new routes
│   ├── __tests__/
│   │   ├── uv_installer.test.ts  # NEW — unit tests for installer
│   │   └── cluster.test.ts       # MODIFIED — updated for auto-install behavior
│   └── Dockerfile                # MODIFIED — pre-install uv + skypilot
├── bin/
│   └── setup                     # MODIFIED — ensure_uv() + ensure_skypilot()
└── src/
    └── lib/
        └── cluster_client.ts     # MODIFIED — new client functions
```

**Structure Decision**: Extends existing gatekeeper service layer. `uv_installer.ts` is a new service alongside `sky_runner.ts`. No new directories needed — follows existing `services/`, `handlers/`, `__tests__/` pattern.

## Key Design Decisions

### 1. Managed Path: `~/.carapace/`

All uv and SkyPilot files live under `~/.carapace/`:

```
~/.carapace/
  uv/bin/uv                          # uv binary
  tools/bin/sky                      # sky symlink → venv entry point
  tools/environments/skypilot-nightly/ # isolated venv
  python/cpython-3.12.../            # managed Python runtime
```

Controlled by: `UV_TOOL_BIN_DIR`, `UV_TOOL_DIR`, `UV_PYTHON_INSTALL_DIR`

### 2. uv Download

Download from GitHub Releases using platform-detected target triple:
- `https://github.com/astral-sh/uv/releases/latest/download/uv-{arch}-{os}.tar.gz`
- Extract with `--strip-components=1` (tarball has subdirectory)
- Set executable bit

### 3. SkyPilot Install

```bash
UV_TOOL_BIN_DIR=~/.carapace/tools/bin \
UV_TOOL_DIR=~/.carapace/tools/environments \
UV_PYTHON_INSTALL_DIR=~/.carapace/python \
~/.carapace/uv/bin/uv tool install "skypilot-nightly[aws]"
```

uv auto-downloads Python 3.12 if needed. Creates self-contained shim at `tools/bin/sky`.

### 4. sky_binary() Resolution

```
1. Check ~/.carapace/tools/bin/sky (managed)
2. Fall back to Bun.which("sky") (system PATH)
```

### 5. Lazy Install Flow

```
User clicks "Launch Server"
  → POST /cluster/launch
    → sky_binary() returns null
    → ensure_skypilot() called with SSE progress callback
      → broadcast_event("Downloading uv...")
      → broadcast_event("Installing SkyPilot...")
      → broadcast_event("SkyPilot ready")
    → sky binary path returned
    → proceed with credential check + provisioning
```

### 6. Concurrency Guard

Module-level `let install_promise: Promise<string> | null = null`. If non-null, callers await the existing promise instead of starting a new install.

## Implementation Steps

1. **Types + path functions**: Add types to `types.ts`, create `uv_installer.ts` with sync path functions + `detect_platform()`, add unit tests
2. **Detection functions**: `detect_uv()`, `detect_sky()`, `check_install_status()` in `uv_installer.ts`
3. **Download + install**: `download_uv()` and `ensure_skypilot()` with progress callbacks
4. **sky_binary() change**: Modify `sky_runner.ts` to check managed path first
5. **Handler integration**: Auto-install in `cluster.ts`, new endpoints, updated error messages
6. **Route wiring**: Add `/cluster/install-status` and `/cluster/ensure-skypilot` to `index.ts`
7. **bin/setup update**: `ensure_uv()` and `ensure_skypilot()` bash functions
8. **Dockerfile update**: Pre-install uv + skypilot at build time

## Complexity Tracking

No constitution violations — no complexity justification needed.
